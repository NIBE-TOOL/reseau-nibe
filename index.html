<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Note de calcul réseau semi-rigide NIBE pour NIBE S735</title>
<style>
  :root{
    --line:#e3e7ee; --text:#1f2630; --muted:#5b6676; --accent:#1b6bd6;
    --zebra:#f7f9fc; --fs-body:14px; --fs-small:12px; --fs-justif:11px;
    --cuisine:#000; --sdb:#1e66ff; --wc:#1b9a43; --autre:#7a3df2;
  }
  *,*::before,*::after{box-sizing:border-box}
  html,body{margin:0;background:#fff;color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1100px;margin:22px auto;padding:18px}

  /* En-tête outil (logo + titre) */
  .app-header{
    display:grid;
    grid-template-columns:120px 1fr 120px;
    align-items:center;
    gap:12px;
    margin-bottom:14px;
  }
  .app-header .brand{justify-self:start}
  .app-header img{height:28px;width:auto}
  h1{font-size:22px;text-transform:uppercase;text-align:center;margin:0}

  .progress{display:flex;gap:8px;margin:12px 0 18px}
  .step{flex:1;height:6px;background:#eff3f9;border-radius:999px;overflow:hidden}
  .step>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),#7aa9ff);transition:width .3s ease}
  .labels{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:-6px}

  .card{border:1px solid var(--line);border-radius:12px;padding:16px;background:#fff;margin-bottom:12px}
  .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .field{display:flex;flex-direction:column}
  label{font-weight:600;font-size:13px;margin-bottom:6px}
  input,select{width:100%;padding:8px;border:1px solid var(--line);border-radius:8px;font-size:14px;background:#fff}
  input[readonly]{background:#f8fafc}
  input:disabled, select:disabled{background:#f4f6f9;color:#8893a2}

  .piece{border:2px solid var(--line);border-radius:12px;padding:12px;margin-top:10px;background:#fff}
  .piece-head{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .piece-title{font-weight:800; letter-spacing:.2px}
  .piece--cuisine{border-color:var(--cuisine)}
  .piece--sdb{border-color:var(--sdb)}
  .piece--wc{border-color:var(--wc)}
  .piece--autre{border-color:var(--autre)}
  .piece--neutral{border-style:dashed}

  .row{display:flex;gap:8px;align-items:center}
  .actions{display:flex;gap:10px;margin-top:12px}
  button{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
  button.secondary{background:#eef3fe;color:#0d3691}
  button.ghost{background:#f7f9ff;color:#0d3691;border:1px dashed #c7d7ff}
  .nav{display:flex;justify-content:space-between;margin-top:10px}

  /* Ligne pédagogique */
  .flow{
    font-weight:900;
    color:var(--text);
    margin-top:6px;
    font-size:16px;
    letter-spacing:.2px;
  }
  .flow .arrow{margin:0 8px; color:var(--muted)}

  /* Vue rapport (page dédiée) */
  #reportScreen{display:none}
  #reportScreen .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    margin-bottom:10px;
  }

  /* Rapport */
  #rapport{
    border:1px solid var(--line);
    border-radius:12px;
    padding:14px;
    background:#fff;
    max-width:900px;
    margin-left:auto;
    margin-right:auto;
  }

  .report-header-bar{
    display:grid;
    grid-template-columns:120px 1fr auto;
    align-items:center;
    gap:10px;
    margin-bottom:6px;
  }
  .report-logo img{max-width:110px; height:auto}
  .report-title{margin:0; font-size:18px; line-height:1.2}
  .header{display:grid;grid-template-columns:1fr 1fr;gap:8px;color:var(--muted);font-size:11px; margin-top:10px}
  .header b{color:var(--text)}
  .rule{height:1px;background:var(--line);margin:10px 0 10px}

  .table-scroll{overflow-x:auto}
  table{width:100%;border-collapse:collapse;font-size:12px;margin-bottom:8px;table-layout:fixed}
  th,td{border:1px solid var(--line);padding:5px;vertical-align:top;text-align:center;line-height:1.2}
  th{background:#f6f8fb}
  td.left{text-align:left}
  .calc{font-size:10px;color:var(--muted);text-align:left;line-height:1.15}
  .sum{font-weight:700;background:#fbfdff}

  #tabMain col.col-elt{width:34%}
  #tabMain col.col-qmin{width:14%}
  #tabMain col.col-qmax{width:14%}
  #tabMain col.col-pdcmin{width:10%}
  #tabMain col.col-pdcmax{width:10%}
  #tabMain col.col-det{width:18%}

  .airTable{width:60%; margin:4px 0 0 auto; font-size:11px}
  .airTable th,.airTable td{padding:5px}
  .airTable th{background:#f9fbff}

  #rapport.tight table{font-size:11px}
  #rapport.tight th,#rapport.tight td{padding:4px}
  #rapport.tight .calc{font-size:9.5px}
  #rapport.ultra table{font-size:10.5px}
  #rapport.ultra th,#rapport.ultra td{padding:4px}
  #rapport.ultra .calc{font-size:9px}
  #rapport.tight .header{font-size:10px}
  #rapport.ultra .header{font-size:9.5px}

  .footnote{
    font-size:10px;
    color:#555;
    margin-top:6px;
    line-height:1.25;
  }

  /* Responsive */
  @media (max-width: 900px){
    .wrap{margin:12px auto;padding:12px}
    h1{font-size:18px}
    .labels{display:none}
    .app-header{grid-template-columns:90px 1fr 0px}
    .app-header img{height:24px}

    .grid-4,.grid-3,.grid-2{grid-template-columns:1fr}
    .nav{flex-direction:column; gap:10px; align-items:stretch}
    .actions{flex-direction:column; align-items:stretch}
    button{width:100%}

    #rapport{max-width:none}
    .report-header-bar{grid-template-columns:1fr; gap:6px}
    .report-title{font-size:16px}
    .airTable{width:100%}
    .flow{font-size:15px}
  }

  @media print{
  @page{ size: A4 portrait; margin: 10mm }

  /* On ne veut pas les boutons "Retour" / "Imprimer" sur la feuille */
  #reportScreen .topbar,
  .printBtn{
    display:none !important;
  }

  .no-print{ display:none !important }
  .wrap{max-width:none;margin:0;padding:0}

  #reportScreen{display:block !important}
  #rapport{
    display:block !important;
    border:0; border-radius:0;
    padding:0;
    margin:0;
    max-width:none;
  }

  #rapport table{font-size:11px}
  #rapport th,#rapport td{padding:4px}
  #rapport .calc{font-size:9px}
  #rapport .header{font-size:10px}
  #rapport .report-title{font-size:16px}
  #rapport .rule{margin:8px 0 8px}

  table{ page-break-inside:avoid }
  tr,td,th{ page-break-inside:avoid; page-break-after:auto }

  html, body {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
}
</style>
</head>
<body>

<!-- ================== APP ================== -->
<div id="app" class="wrap no-print">
  <div class="app-header">
    <div class="brand">
      <img src="https://www.nibe.eu/images/18.6394f9d91836c36799c18b7/1716537072922/nibe-logo-web.svg" alt="NIBE">
    </div>
    <h1>Note de calcul réseau semi-rigide NIBE pour NIBE S735</h1>
    <div></div>
  </div>

  <div class="progress" aria-hidden="true">
    <div class="step"><span id="p1" style="width:0%"></span></div>
    <div class="step"><span id="p2" style="width:0%"></span></div>
    <div class="step"><span id="p3" style="width:0%"></span></div>
    <div class="step"><span id="p4" style="width:0%"></span></div>
    <div class="step"><span id="p5" style="width:0%"></span></div>
    <div class="step"><span id="p6" style="width:0%"></span></div>
  </div>
  <div class="labels" aria-hidden="true">
    <span>Admin</span><span>Logement</span><span>Extraction</span><span>Pièces d’eau</span><span>Rejet</span><span>Rapport</span>
  </div>

  <!-- ÉTAPE 1 : ADMIN -->
  <div class="card" data-step="1">
    <h3>1) Données administratives</h3>
    <div class="grid-3">
      <div class="field"><label>Type de bâtiment</label>
        <select id="bat_type">
          <option value="maison">Maison individuelle</option>
          <option value="collectif">Immeuble collectif</option>
        </select>
      </div>
      <div class="field"><label>Installateur (Nom / Société)</label><input id="inst_nom"></div>
      <div class="field"><label>N° SIRET</label><input id="inst_siret"></div>

      <div class="field"><label>Email installateur</label><input id="inst_email" type="email"></div>
      <div class="field"><label>Date de l'étude</label><input id="date_etude" type="date"></div>
      <div class="field"><label>Nom et prénom (qui a réalisé cette étude)</label><input id="audit_fullname" placeholder="Ex : Marie Martin"></div>

      <div class="field"><label>Email client final</label><input id="client_email" type="email"></div>
      <div class="field" style="grid-column:1/-1"><label>Nom et adresse du chantier</label><input id="client_adresse" placeholder="Nom client – Adresse complète"></div>
    </div>
    <div class="nav">
      <span></span>
      <div class="actions"><button type="button" onclick="showStep(2)">Continuer</button></div>
    </div>
  </div>

  <!-- ÉTAPE 2 : LOGEMENT -->
  <div class="card" data-step="2" style="display:none">
    <h3>2) Type de logement</h3>
    <div class="grid-2">
      <div class="field" style="max-width:340px">
        <label>Nombre de chambres</label>
        <select id="nb_chambres" onchange="onChambresChange()">
          <option value="1">1 chambre (T2)</option>
          <option value="2">2 chambres (T3)</option>
          <option value="3" selected>3 chambres (T4)</option>
          <option value="4">4 chambres (T5)</option>
          <option value="5">5 chambres (T6)</option>
          <option value="6">6 chambres (T7)</option>
          <option value="7">7 chambres et + (T7+)</option>
        </select>
      </div>
      <div class="field">
        <label>Pièces principales supplémentaires</label>
        <div id="pp_list"></div>
        <div class="actions" style="margin-top:6px">
          <button type="button" class="ghost" onclick="ppAdd()">+ Ajouter une pièce principale</button>
        </div>
      </div>
    </div>
    <div class="nav">
      <button class="secondary" type="button" onclick="showStep(1)">Retour</button>
      <!-- ✅ FIX : plus d'appel à refreshAllPieces('#pieces') (fonction inexistante dans cette version) -->
      <div class="actions"><button type="button" onclick="applyCuisineDefaults();enforceT2Minimum60();showStep(3)">Continuer</button></div>
    </div>
  </div>

  <!-- ÉTAPE 3 : EXTRACTION -->
  <div class="card" data-step="3" style="display:none">
    <h3>3) Conduit d’extraction</h3>
    <div class="flow">Répartiteur <span class="arrow">➜</span> S735</div>

    <div class="grid-4" style="margin-top:10px">
      <div class="field"><label>Diamètre (mm)</label>
        <select id="main_diam"><option>125</option><option>160</option><option>200</option></select>
      </div>
      <div class="field"><label>Longueur droite (m)</label><input id="main_len" type="number" min="0" step="0.1" required placeholder="Ex : 6"></div>
      <div class="field"><label>Coudes 90°</label><input id="main_c90" type="number" value="2" min="0"></div>
      <div class="field"><label>Coudes 45°</label><input id="main_c45" type="number" value="0" min="0"></div>
    </div>
    <div class="nav">
      <button class="secondary" type="button" onclick="showStep(2)">Retour</button>
      <div class="actions"><button type="button" onclick="if(validateStep3()) showStep(4);">Continuer</button></div>
    </div>
  </div>

  <!-- ÉTAPE 4 : PIÈCES D'EAU -->
  <div class="card" data-step="4" style="display:none">
    <h3>4) Pièces d’eau (Ø90 semi-rigide)</h3>

    <!-- Cuisine : débit caché mais calculé, longueur obligatoire -->
    <div class="piece piece--cuisine" id="piece_cuisine">
      <div class="piece-head">
        <div class="piece-title">CUISINE (2×Ø90)</div>
      </div>

      <!-- Débits internes cachés -->
      <input id="cui_q_min" type="hidden">
      <input id="cui_q_max" type="hidden">

      <div class="grid-2" style="margin-top:10px">
        <div class="field"><label>Longueur Ø90 (m – par gaine)</label><input id="cui_len" type="number" min="0" step="0.1" required placeholder="À renseigner"></div>
        <div class="field"><label style="opacity:.7"> </label><div style="height:38px"></div></div>
      </div>
    </div>

    <div id="pieces"></div>
    <div class="actions" style="margin-top:10px">
      <button type="button" class="secondary" onclick="addPiece()">+ Ajouter une pièce d'eau</button>
    </div>

    <div class="nav">
      <button class="secondary" type="button" onclick="showStep(3)">Retour</button>
      <div class="actions"><button type="button" onclick="if(validateStep4()) showStep(5);">Continuer</button></div>
    </div>
  </div>

  <!-- ÉTAPE 5 : REJET + SORTIE -->
  <div class="card" data-step="5" style="display:none">
    <h3>5) Conduit de rejet</h3>
    <div class="flow">S735 <span class="arrow">➜</span> Extérieur</div>

    <div class="grid-4" style="margin-top:10px">
      <div class="field"><label>Diamètre (mm)</label><select id="rej_diam" onchange="syncSortieDiam()"><option>125</option><option>160</option><option>200</option></select></div>
      <div class="field"><label>Longueur droite (m)</label><input id="rej_len" type="number" min="0" step="0.1" required placeholder="Ex : 6"></div>
      <div class="field"><label>Coudes 90°</label><input id="rej_c90" type="number" value="1" min="0"></div>
      <div class="field"><label>Coudes 45°</label><input id="rej_c45" type="number" value="0" min="0"></div>
    </div>

    <div class="grid-2" style="margin-top:10px">
      <div class="field"><label>Type de sortie</label>
        <select id="sortie_type" onchange="onSortieTypeChange()">
          <option value="toiture">Toiture isolée (Ø125/160 → 5 Pa)</option>
          <option value="facade_inox">Façade INOX</option>
          <option value="facade_design">Façade Design</option>
        </select>
      </div>
      <div class="field">
        <label>Diamètre sortie</label>
        <input id="sortie_diam_ro" type="text" readonly value="125">
      </div>
    </div>

    <div class="nav">
      <button class="secondary" type="button" onclick="showStep(4)">Retour</button>
      <div class="actions"><button id="genBtn" type="button" onclick="generateReport()">Générer le rapport</button></div>
    </div>
  </div>
</div>

<!-- ================== REPORT SCREEN (PAGE DÉDIÉE) ================== -->
<div id="reportScreen" class="wrap no-print">
  <div class="topbar">
    <button class="secondary" type="button" onclick="backToApp()">← Retour au formulaire</button>
    <button type="button" class="secondary printBtn" onclick="window.print()">Imprimer</button>
  </div>

  <div id="rapport">
    <div class="report-header-bar">
      <div class="report-logo">
        <img src="https://www.nibe.eu/images/18.6394f9d91836c36799c18b7/1716537072922/nibe-logo-web.svg" alt="NIBE">
      </div>
      <h2 class="report-title">Note de calcul – Réseau de ventilation (semi-rigide)</h2>
      <div></div>
    </div>

    <div class="header" id="r-head-1"></div>
    <div class="header" id="r-head-2"></div>
    <div class="rule"></div>

    <div class="table-scroll">
      <table id="tabMain">
        <colgroup>
          <col class="col-elt"><col class="col-qmin"><col class="col-qmax"><col class="col-pdcmin"><col class="col-pdcmax"><col class="col-det">
        </colgroup>
        <thead>
          <tr>
            <th class="left">Élément</th>
            <th>Débit mini<br>(m³/h)</th>
            <th>Grand débit cuisine<br>(m³/h)</th>
            <th>PDC mini<br>(Pa)</th>
            <th>PDC grand<br>(Pa)</th>
            <th class="left">Détails calcul</th>
          </tr>
        </thead>
        <tbody id="r-rows"></tbody>
      </table>
    </div>

    <div class="table-scroll">
      <table class="airTable" id="tabAir">
        <thead><tr><th class="left">Entrées d’air</th><th>Débit (m³/h)</th></tr></thead>
        <tbody id="r-air"></tbody>
      </table>
    </div>

    <div class="footnote">
      Le présent document constitue une note de calcul indicative du réseau de ventilation.
      Les pertes de charge sont établies à partir des données fabricants et des hypothèses renseignées.
      <br>
      Joindre au présent rapport le <b>schéma du réseau</b> et l’<b>implantation des bouches</b>.
    </div>
  </div>
</div>

<script>
/* ========= Données PERTE de CHARGE – SEMI-RIGIDE ========= */
const BOUCHE = {
  simple: { 15:1, 30:3 },
  cuisine: { 90:3.5, 105:4, 120:5.5, 135:7 }
};
const COND90 = {
  simple: { 15:0.3, 30:1 },
  cuisine2: { 30:2, 90:7, 105:8, 120:12, 135:16 }
};
const MAIN_LIN = {
  125: { 60:0.25,75:0.3,90:0.4,105:0.7,120:1,135:1.2,150:1.4,165:1.6 },
  160: { 60:0.1,75:0.15,90:0.2,105:0.25,120:0.3,135:0.4,150:0.5,165:0.6,180:0.65,195:0.7,210:0.75,225:0.8,240:0.85,255:0.9,270:0.95,285:1.0 },
  200: { 60:0.02,75:0.05,90:0.07,105:0.10,120:0.14,135:0.17,150:0.20,165:0.25,180:0.28,195:0.30,210:0.35,225:0.38,240:0.40,255:0.43,270:0.48,285:0.50,300:0.55,315:0.60,330:0.68,345:0.75,360:0.80,375:0.85,390:0.90,405:1.00 }
};
const MAIN_90 = {
  125: { 60:1,75:1.7,90:2,105:2.3,120:3,135:4,150:5,165:6 },
  160: { 60:0.5,75:0.7,90:0.8,105:1,120:1.3,135:1.6,150:2,165:2.3,180:2.6,195:3,210:3.5,225:4,240:4.2,255:5,270:5.5,285:6 },
  200: { 60:0.1,75:0.2,90:0.3,105:0.4,120:0.5,135:0.6,150:0.65,165:0.75,180:0.85,195:0.92,210:1,225:1.2,240:1.5,255:1.65,270:1.8,285:2,300:2.2,315:2.4,330:2.8,345:3,360:3.2,375:3.6,390:3.8,405:4 }
};

const SORTIE = {
  facade_inox: {
    125:{60:6,75:9,90:12,105:14,120:15,135:17,150:20,165:22},
    160:{60:4,75:5,90:8,105:9,120:10,135:12,150:15,165:16,180:19,195:22,210:23,225:24,240:25,255:26,270:30,285:35},
    200:{60:4,75:5,90:7,105:8,120:9,135:11,150:14,165:15,180:17,195:19,210:20,225:21,240:22,255:23,270:25,285:25,300:28,315:32,330:35,345:40,360:45,375:50,390:53,405:55}
  },
  facade_design: {
    125:{60:10,75:10,90:15,105:15,120:20,135:20,150:20,165:20},
    160:{60:5,75:5,90:10,105:10,120:10,135:15,150:15,165:15,180:20,195:20,210:25,225:25,240:30,255:35,270:40,285:55},
    200:{60:3,75:3,90:5,105:5,120:10,130:10,150:13,165:13,180:15,195:17,210:20,225:20,240:25,255:25,270:30,285:30,300:30,315:35,330:35,345:35,360:40,375:40,390:50,405:60}
  },
  toiture: { fixed:5 }
};

/* ========= Règles logement / entrées d'air ========= */
function titreLogement(nb){ nb=+nb; if(nb<=1)return'T2'; if(nb===2)return'T3'; if(nb===3)return'T4'; if(nb===4)return'T5'; if(nb===5)return'T6'; return (nb>=7)?'T7+':'T7'; }
function cuisineDefaults(nb){ nb=+nb; if(nb<=1)return{mini:30,grand:90}; if(nb===2)return{mini:45,grand:105}; if(nb===3)return{mini:45,grand:120}; return{mini:45,grand:135}; }
function debitFuite(type, nbCh){
  const T=titreLogement(nbCh);
  const maison={T2:45,T3:60,T4:75,T5:90,T6:105,'T7':120,'T7+':120};
  const coll  ={T2:30,T3:40,T4:50,T5:60,T6:70,'T7':80,'T7+':80};
  return type==='maison'?(maison[T]??0):(coll[T]??0);
}
function baseEntreesAir(nbCh, ppNames){
  const list=[]; const qStd=(nbCh>=5)?22:30;
  for(let i=1;i<=nbCh;i++) list.push({lib:`Chambre ${i}`,q:qStd,type:'ch'});
  ppNames.forEach(n=>list.push({lib:n,q:qStd,type:'pp'}));
  list.push({lib:'Séjour',q:(nbCh<=2?60:45),type:'sej'});
  return list;
}
function ajusterEntreesAir(liste, besoinMini){
  let note='',modif=false; const sum=()=>liste.reduce((s,a)=>s+a.q,0);
  if(sum()<besoinMini){
    let ch=false;
    liste.forEach(a=>{ if((a.type==='ch'||a.type==='pp')&&a.q===22){a.q=30; ch=true;} });
    if(ch){note+='Chambres/PP → 30 m³/h. '; modif=true;}
  }
  if(sum()<besoinMini){
    const sej=liste.find(a=>a.type==='sej');
    if(sej&&sej.q<90){sej.q=90; note+='Séjour → 2×45=90 m³/h. '; modif=true;}
  }
  return {liste, note:note.trim(), modif};
}

/* ========= UI helpers ========= */
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));

function showStep(n){
  $$('.card').forEach(c=> c.style.display=(+c.dataset.step===n?'':'none'));
  for(let i=1;i<=6;i++){
    const el=$('#p'+i);
    if(el) el.style.width=(i<=n?'100%':'0%');
  }
}

/* ========= PP ========= */
const ppListEl=$('#pp_list');
function makePPRow(name='Pièce principale'){
  const row=document.createElement('div'); row.className='row'; row.style.marginTop='6px';
  row.innerHTML=`<input class="pp_name" value="${name.replace(/"/g,'&quot;')}" style="flex:1">
                 <button type="button" class="ghost pp_remove">Supprimer</button>`;
  row.querySelector('.pp_remove').addEventListener('click',()=>row.remove());
  return row;
}
function ppAdd(){ ppListEl.appendChild(makePPRow('Bureau')); }
function getPPNames(){ return Array.from(document.querySelectorAll('#pp_list .pp_name')).map(i=>i.value.trim()).filter(Boolean); }

/* ========= Pièces d'eau ========= */
function setPieceEnabled(piece, enabled){
  const nom = piece.querySelector('input[name="nom"]');
  const len = piece.querySelector('input[name="len"]');
  nom.disabled = !enabled;
  len.disabled = !enabled;
  if(!enabled){
    nom.value = '';
    len.value = '';
    piece.classList.add('piece--neutral');
  } else {
    piece.classList.remove('piece--neutral');
  }
}
function makePieceRow(){
  const box=document.createElement('div');
  box.className='piece piece--neutral';

  box.innerHTML=`
    <div class="piece-head">
      <div class="piece-title">PIÈCE D’EAU</div>
      <button type="button" class="ghost" onclick="this.closest('.piece').remove();">Supprimer</button>
    </div>

    <div class="grid-3" style="margin-top:10px">
      <div class="field"><label>Type</label>
        <select name="type" onchange="onTypeChange(this)">
          <option value="" selected>— Choisir —</option>
          <option value="sdb">Salle de bain / Douche</option>
          <option value="wc">WC</option>
          <option value="autre">Buanderie / Autre</option>
        </select>
      </div>

      <div class="field"><label>Nom</label>
        <input name="nom" disabled placeholder="Auto après choix du type">
      </div>

      <div class="field"><label>Longueur Ø90 (m)</label>
        <input name="len" type="number" min="0" step="0.1" required disabled placeholder="À renseigner">
      </div>
    </div>

    <!-- Débit calculé mais caché -->
    <input name="q" type="hidden" value="">
  `;

  setPieceEnabled(box, false);
  return box;
}

function addPiece(){
  $('#pieces').appendChild(makePieceRow());
}

function nextIndexFor(type){
  const pieces = Array.from(document.querySelectorAll('#pieces .piece'));
  let max = 0;
  for(const p of pieces){
    const t = p.querySelector('select[name="type"]')?.value || '';
    if(t !== type) continue;
    const name = (p.querySelector('input[name="nom"]')?.value || '').trim();
    const m = name.match(/(\d+)\s*$/);
    if(m) max = Math.max(max, parseInt(m[1],10));
  }
  return max + 1;
}

function applyPieceClass(piece, type){
  piece.classList.remove('piece--sdb','piece--wc','piece--autre');
  if(type==='sdb') piece.classList.add('piece--sdb');
  if(type==='wc') piece.classList.add('piece--wc');
  if(type==='autre') piece.classList.add('piece--autre');
}

function onTypeChange(select){
  const piece = select.closest('.piece');
  const type = select.value;

  if(!type){
    piece.classList.remove('piece--sdb','piece--wc','piece--autre');
    setPieceEnabled(piece, false);
    piece.querySelector('input[name="q"]').value = '';
    return;
  }

  setPieceEnabled(piece, true);
  applyPieceClass(piece, type);

  const nom = piece.querySelector('input[name="nom"]');
  const q   = piece.querySelector('input[name="q"]');

  // Débits internes (non affichés)
  q.value = (type==='sdb') ? 30 : 15;

  // Nom auto numéroté : SDB 1..n / WC 1..n (pas de numérotation sur "autre")
  if(type==='sdb'){
    const idx = nextIndexFor('sdb');
    nom.value = `Salle de bain ${idx}`;
  } else if(type==='wc'){
    const idx = nextIndexFor('wc');
    nom.value = `WC ${idx}`;
  } else {
    // autre : nom simple
    if(!nom.value.trim()) nom.value = 'Buanderie';
  }
}

/* ========= Cuisine ========= */
function applyCuisineDefaults(){
  const nb=+($('#nb_chambres')?.value||3);
  const d=cuisineDefaults(nb);
  $('#cui_q_min').value=d.mini;
  $('#cui_q_max').value=d.grand;
}

/* ========= T2 minimum ========= */
function enforceT2Minimum60(){
  const nbCh = +($('#nb_chambres')?.value || 3);
  const T = titreLogement(nbCh);
  if (T !== 'T2') return;

  const cont = $('#pieces');
  const pieces = Array.from(cont.querySelectorAll('.piece'));
  if (pieces.length === 0){
    cont.appendChild(makePieceRow());
  }
}
function onChambresChange(){
  applyCuisineDefaults();
  enforceT2Minimum60();
}

/* ========= Calculs ========= */
function interpTable(tbl, q){
  const keys = Object.keys(tbl).map(Number).sort((a,b)=>a-b);
  if (!keys.length) return 0;
  if (q<=keys[0]) return tbl[keys[0]];
  if (q>=keys[keys.length-1]) return tbl[keys[keys.length-1]];
  for(let i=0;i<keys.length-1;i++){
    const a=keys[i], b=keys[i+1];
    if (q>=a && q<=b){
      const ya=tbl[a], yb=tbl[b];
      const t=(q-a)/(b-a);
      return ya + t*(yb-ya);
    }
  }
  return 0;
}
function pdcBoucheSimple(q){ return (q<=15)?BOUCHE.simple[15]:BOUCHE.simple[30]; }
function pdcBoucheCuisine(q){ return interpTable(BOUCHE.cuisine, q); }
function pdcCond90_simple(q, len){ const k = (q<=15)?COND90.simple[15]:COND90.simple[30]; return k*len; }
function pdcCond90_cuisine(q, len){ return interpTable(COND90.cuisine2, q) * len; }
function pdcMain(diam, q, len, n45, n90){
  const kLin = interpTable(MAIN_LIN[diam], q);
  const k90  = interpTable(MAIN_90[diam], q);
  const p = kLin*len + (n90||0)*k90 + (n45||0)* (k90/2);
  const det = `Lin ${kLin.toFixed(3)} Pa/m × ${len} m ; 45° ${(k90/2).toFixed(2)} × ${n45||0} ; 90° ${k90.toFixed(2)} × ${n90||0}`;
  return { p, det };
}
function pdcSortie(type, diam, q){
  if(type==='toiture'){ return 5; }
  const table = SORTIE[type]?.[diam];
  if(!table) return 0;
  return interpTable(table, q);
}
function labelSortie(t){ return t==='toiture'?'Toiture isolée':(t==='facade_inox'?'Façade INOX':'Façade Design'); }

/* ========= Validations de navigation ========= */
function validateStep3(){
  const mainLen = $('#main_len').value;
  if(mainLen==='' || +mainLen<0){
    alert("Merci de renseigner la longueur du conduit d’extraction (étape 3).");
    return false;
  }
  return true;
}

function validateStep4(){
  const cuiLen = $('#cui_len').value;
  if(cuiLen==='' || +cuiLen<0){
    alert("Merci de renseigner la longueur Ø90 de la cuisine (étape 4).");
    return false;
  }

  const pieces = Array.from(document.querySelectorAll('#pieces .piece'));
  for(const p of pieces){
    const type = p.querySelector('select[name="type"]')?.value || '';
    const len  = p.querySelector('input[name="len"]')?.value ?? '';
    if(!type){
      alert("Une pièce d’eau est incomplète : merci de choisir le type (étape 4) ou de supprimer la pièce.");
      return false;
    }
    if(len==='' || +len<0){
      alert("Une pièce d’eau est incomplète : merci de renseigner la longueur Ø90 (étape 4).");
      return false;
    }
  }
  return true;
}

function validateStep5(){
  const rejLen = $('#rej_len').value;
  if(rejLen==='' || +rejLen<0){
    alert("Merci de renseigner la longueur du conduit de rejet (étape 5).");
    return false;
  }
  return true;
}

/* ========= Sortie : diamètre déduit ========= */
function syncSortieDiam(){
  const d = +$('#rej_diam').value;
  $('#sortie_diam_ro').value = String(d);
}
function onSortieTypeChange(){}

/* ========= Rapport ========= */
function generateReport(){
  if(!validateStep3()){ showStep(3); return; }
  if(!validateStep4()){ showStep(4); return; }
  if(!validateStep5()){ showStep(5); return; }

  // Admin
  const inst=$('#inst_nom').value||'—', siret=$('#inst_siret').value||'—', mailI=$('#inst_email').value||'—';
  const date=$('#date_etude').value ? new Date($('#date_etude').value).toLocaleDateString('fr-FR') : new Date().toLocaleDateString('fr-FR');
  const audit=$('#audit_fullname').value||'—';
  const mailC=$('#client_email').value||'—', addr=$('#client_adresse').value||'—', bat=$('#bat_type').value;

  // Marques forcées
  const bB='NIBE', bE='NIBE';

  // Logement
  const nbCh=+$('#nb_chambres').value, Tlog=titreLogement(nbCh);
  applyCuisineDefaults();
  const ppNames=getPPNames();

  // Conduit extraction
  const main_d=+$('#main_diam').value, main_l=+$('#main_len').value, main_c45=+$('#main_c45').value, main_c90=+$('#main_c90').value;

  // Cuisine
  const cui_q_min=+($('#cui_q_min').value||0), cui_q_max=+($('#cui_q_max').value||0), cui_len=+($('#cui_len').value||0);

  // Pièces d'eau
  const autres=$$('#pieces .piece').map(n=>({
    nom:n.querySelector('input[name="nom"]').value||'Pièce d’eau',
    type:n.querySelector('select[name="type"]').value,
    q:+(n.querySelector('input[name="q"]').value||0),
    len:+(n.querySelector('input[name="len"]').value||0)
  }));

  // Rejet + sortie
  const rej_d=+$('#rej_diam').value, rej_l=+$('#rej_len').value, rej_c45=+$('#rej_c45').value, rej_c90=+$('#rej_c90').value;
  const sortie_type=$('#sortie_type').value;
  const sortie_diam=rej_d; // ✅ déduit

  // Débits totaux
  let sumQmini=cui_q_min, sumQgrand=cui_q_max;
  autres.forEach(p=>{ sumQmini+=p.q; sumQgrand+=p.q; });

  const rows=[];
  let sumPmin=0, sumPmax=0;

  // Cuisine
  const qMinCui = Math.max(90, Math.min(135, cui_q_min));
  const pB_cui_min = pdcBoucheCuisine(qMinCui);
  const pB_cui_max = pdcBoucheCuisine(cui_q_max);
  const pL_cui_min = pdcCond90_cuisine(qMinCui, cui_len);
  const pL_cui_max = pdcCond90_cuisine(cui_q_max, cui_len);
  rows.push({
    label:`Cuisine (2×Ø90)`,
    qMin:cui_q_min, qGrand:cui_q_max,
    pMin:(pB_cui_min+pL_cui_min), pMax:(pB_cui_max+pL_cui_max),
    det:`Bouche ${pB_cui_min.toFixed(2)} / ${pB_cui_max.toFixed(2)} Pa ; Conduits ${pL_cui_min.toFixed(2)} / ${pL_cui_max.toFixed(2)} Pa (len ${cui_len} m)`
  });
  sumPmin += pB_cui_min + pL_cui_min;
  sumPmax += pB_cui_max + pL_cui_max;

  // Autres pièces
  autres.forEach(p=>{
    const pB = pdcBoucheSimple(p.q);
    const pL = pdcCond90_simple(p.q, p.len);
    const pTot = pB + pL;
    rows.push({
      label:`${p.nom} (Ø90)`, qMin:p.q, qGrand:p.q,
      pMin:pTot, pMax:pTot,
      det:`Bouche ${pB.toFixed(2)} Pa ; Conduit ${pL.toFixed(2)} Pa (len ${p.len} m)`
    });
    sumPmin += pTot; sumPmax += pTot;
  });

  // Conduit extraction
  const PMmin = pdcMain(main_d, sumQmini, main_l, main_c45, main_c90);
  const PMmax = pdcMain(main_d, sumQgrand, main_l, main_c45, main_c90);
  rows.push({
    label: `Conduit d’extraction (répartiteur ➜ S735) Ø${main_d}`,
    qMin: sumQmini, qGrand: sumQgrand,
    pMin: PMmin.p, pMax: PMmax.p,
    det: `${PMmin.det}`
  });
  sumPmin += PMmin.p; sumPmax += PMmax.p;

  // Conduit rejet + sortie
  const PRmin = pdcMain(rej_d, sumQmini, rej_l, rej_c45, rej_c90);
  const PRmax = pdcMain(rej_d, sumQgrand, rej_l, rej_c45, rej_c90);
  const pSortMin = pdcSortie(sortie_type, sortie_diam, sumQmini);
  const pSortMax = pdcSortie(sortie_type, sortie_diam, sumQgrand);
  rows.push({
    label: `Conduit de rejet (S735 ➜ Extérieur) Ø${rej_d} + Sortie (${labelSortie(sortie_type)} Ø${sortie_diam})`,
    qMin: sumQmini, qGrand: sumQgrand,
    pMin: PRmin.p + pSortMin, pMax: PRmax.p + pSortMax,
    det: `${PRmin.det} ; Sortie ${pSortMin.toFixed(2)} / ${pSortMax.toFixed(2)} Pa`
  });
  sumPmin += PRmin.p + pSortMin; sumPmax += PRmax.p + pSortMax;

  // Entrées d’air
  let airList=baseEntreesAir(nbCh,ppNames);
  const fuite=debitFuite(bat,nbCh);
  const besoinMini=sumQgrand - fuite;
  const aj=ajusterEntreesAir(airList,besoinMini);
  airList=aj.liste; const sumAir=airList.reduce((s,a)=>s+a.q,0);

  // Rendu en-tête
  $('#r-head-1').innerHTML =
    `<div><b>Installateur :</b> ${inst} (${siret}) — ${mailI}</div>
     <div><b>Étude réalisée par :</b> ${audit}</div>`;
  $('#r-head-2').innerHTML =
    `<div><b>Client :</b> ${addr} — ${mailC}<br>
         <b>Type de bâtiment :</b> ${bat==='maison'?'Maison individuelle':'Immeuble collectif'}<br>
         <b>Type de logement :</b> ${Tlog}</div>
     <div><b>Date :</b> ${date}<br>
         <b>Marques :</b> Bouches=${bB} ; Entrées d’air=${bE}</div>`;

  // Tableau principal
  const tbody=$('#r-rows'); tbody.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="left">${r.label}</td>
                  <td>${r.qMin.toFixed(0)}</td>
                  <td>${r.qGrand.toFixed(0)}</td>
                  <td>${r.pMin.toFixed(2)}</td>
                  <td>${r.pMax.toFixed(2)}</td>
                  <td class="calc">${r.det}</td>`;
    tbody.appendChild(tr);
  });
  const trTot=document.createElement('tr'); trTot.className='sum';
  trTot.innerHTML=`<td class="left">TOTAL — Somme des débits / PDC</td>
                   <td>${sumQmini.toFixed(0)}</td>
                   <td>${sumQgrand.toFixed(0)}</td>
                   <td>${sumPmin.toFixed(2)}</td>
                   <td>${sumPmax.toFixed(2)}</td>
                   <td>${aj.modif?`<span class="calc">Ajustements EA : ${aj.note}</span>`:''}</td>`;
  tbody.appendChild(trTot);

  // Tableau entrées d’air
  const airBody=$('#r-air'); airBody.innerHTML='';
  airList.forEach(a=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="left">${a.lib}</td><td>${a.q}</td>`;
    airBody.appendChild(tr);
  });
  const trAirTot=document.createElement('tr'); trAirTot.className='sum';
  trAirTot.innerHTML=`<td class="left">Total entrées d’air</td><td>${sumAir.toFixed(0)}</td>`;
  airBody.appendChild(trAirTot);

  const trFuite=document.createElement('tr');
  trFuite.innerHTML=`<td class="left"><span class="calc"><b>Débit de fuite</b> (m³/h)</span></td><td>${fuite.toFixed(0)}</td>`;
  airBody.appendChild(trFuite);

  // Ajustement densité
  const rEl=$('#rapport'); rEl.classList.remove('tight','ultra');
  const linesMain=rows.length+1, linesAir=airList.length+2, totalLines=linesMain+Math.ceil(linesAir*0.7);
  if(totalLines>24 && totalLines<=32) rEl.classList.add('tight');
  if(totalLines>32) rEl.classList.add('ultra');

  // Affiche la page rapport
  document.getElementById('app').style.display='none';
  document.getElementById('reportScreen').style.display='block';
  window.scrollTo({top:0,behavior:'smooth'});
}

function backToApp(){
  document.getElementById('reportScreen').style.display='none';
  document.getElementById('app').style.display='block';
  showStep(5);
  window.scrollTo({top:0,behavior:'smooth'});
}

/* ========= Init ========= */
function init(){
  const d=$('#date_etude'); if(d) d.valueAsDate=new Date();
  applyCuisineDefaults();
  enforceT2Minimum60();
  syncSortieDiam();
  showStep(1);
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
